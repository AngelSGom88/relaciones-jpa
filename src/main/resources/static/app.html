<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Relaciones JPA – Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { --gap: 10px; --muted:#6b7280; --ok:#16a34a; --err:#dc2626; }
        body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin:20px; }
        h1 { margin:0 0 8px; }
        .row { display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center; }
        label { font-size:14px; }
        input, select, button, textarea { padding:8px; font-size:14px; }
        input[type="number"]{ width:90px; }
        .card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin:10px 0; background:#fff; }
        .muted { color:var(--muted); }
        .ok { color:#fff; background:var(--ok); padding:2px 6px; border-radius:6px; }
        .danger { color:#fff; background:var(--err); padding:8px; border-radius:8px; }
        pre { background:#f8fafc; border:1px solid #e5e7eb; padding:8px; border-radius:8px; overflow:auto; }
        .grid { display:grid; gap:var(--gap); grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); }
        .section-title { margin-top:20px; }
        .inline { display:inline-block; }
        .addr-row input { margin-right:6px; }
        .small { font-size:12px; }
    </style>
</head>
<body>
<h1>Relaciones JPA – Tester</h1>

<div class="row card">
    <div>
        <label>Relación:</label>
        <select id="rel">
            <option value="1-1">1–1</option>
            <option value="1-N" selected>1–N</option>
        </select>
    </div>
    <div>
        <label>Variante:</label>
        <select id="variant"></select>
    </div>
    <div class="small muted">Los endpoints se fijan automáticamente según la variante.</div>
</div>

<div class="grid">
    <div class="card">
        <h3 class="section-title">Personas — CRUD</h3>
        <form id="createForm" class="row">
            <input name="nombre" placeholder="nombre (crear)" required />
            <button>Crear</button>
            <span id="createMsg"></span>
        </form>
        <form id="updateForm" class="row">
            <input name="id" type="number" placeholder="id (update)" required />
            <input name="nombre" placeholder="nuevo nombre" />
            <button>Actualizar</button>
            <span id="updateMsg"></span>
        </form>
        <form id="deleteForm" class="row">
            <input name="id" type="number" placeholder="id (delete)" required />
            <button>Eliminar</button>
            <span id="deleteMsg"></span>
        </form>
    </div>

    <div class="card">
        <h3 class="section-title">Direcciones — Añadir / Eliminar</h3>
        <form id="addChildForm">
            <div class="row">
                <input name="id" type="number" placeholder="ID persona (padre)" required />
            </div>
            <div id="addChildDynamic" class="addr-row">
                <!-- Se rellena según variante -->
            </div>
            <div class="row">
                <button>Añadir dirección</button>
                <span id="addChildMsg"></span>
            </div>
        </form>

        <hr/>

        <form id="delChildForm" class="row">
            <span class="inline">Eliminar dirección:</span>
            <input name="personaId" type="number" placeholder="ID persona" />
            <input name="childId" type="number" placeholder="ID dirección" required />
            <button>Eliminar</button>
            <span id="delChildMsg"></span>
        </form>
        <div class="small muted">En UNI-B no hace falta el ID de persona para borrar; se oculta automáticamente.</div>
    </div>
</div>

<div class="card">
    <div class="row">
        <button id="reloadBtn">Recargar listado</button>
        <span id="loadMsg" class="small muted"></span>
    </div>
    <div id="list"></div>
</div>

<script>
    // ===== util =====
    const esc = s => (s==null?'':String(s))
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");
    async function safeFetch(url, opts={}){
      const o = { headers:{'Content-Type':'application/json'}, ...opts };
      const res = await fetch(url, o);
      if(!res.ok){
        let detail = '';
        try{ const j = await res.json(); detail = j.detail || j.message || JSON.stringify(j); }catch{}
        throw new Error(`${res.status} ${res.statusText}${detail? ' — '+detail : ''}`);
      }
      if (res.status === 204) return null;
      return res.json();
    }

    // ===== state y variantes =====
    const rel = document.getElementById('rel');
    const variant = document.getElementById('variant');
    const listDiv = document.getElementById('list');

    const BASES = {
      '1-1:bi':     { personas: 'http://localhost:8081/r11bi/personas' },
      '1-1:uni':    { personas: 'http://localhost:8081/r11uni/personas' },
      '1-N:bi':     { personas: 'http://localhost:8081/r1nbi/personas' },
      '1-N:uni-a':  { personas: 'http://localhost:8081/r1nuni-a/personas' },
      '1-N:uni-b':  { personas: 'http://localhost:8081/r1nuni-b/personas', direcciones:'http://localhost:8081/r1nuni-b/direcciones' }
    };

    function addOpt(sel, label, val){ const o=document.createElement('option'); o.value=val; o.textContent=label; sel.appendChild(o); }

    function setVariants(){
      variant.innerHTML='';
      if(rel.value==='1-1'){
        addOpt(variant,'BI (/r11bi/personas)','1-1:bi');
        addOpt(variant,'UNI (/r11uni/personas)','1-1:uni');
      }else{
        addOpt(variant,'BI (/r1nbi/personas)','1-N:bi');
        addOpt(variant,'UNI-A (per → dir)','1-N:uni-a');
        addOpt(variant,'UNI-B (dir → per)','1-N:uni-b');
      }
      const saved = localStorage.getItem('variant');
      if(saved && [...variant.options].some(o=>o.value===saved)) variant.value=saved;
      rebuildDynamicForms();
      loadList();
    }

    function direccionRow(prefix){
      return `
        <div class="row addr-row">
          <input name="${prefix}.calle" placeholder="calle" required />
          <input name="${prefix}.ciudad" placeholder="ciudad" required />
          <input name="${prefix}.cp" placeholder="cp" required />
          <input name="${prefix}.provincia" placeholder="provincia" required />
          <input name="${prefix}.etiqueta" placeholder="etiqueta (opcional)" />
        </div>`;
    }

    function rebuildDynamicForms(){
      const v = variant.value;
      document.getElementById('addChildDynamic').innerHTML = direccionRow('addChild');

      // En UNI-B ocultamos el personaId en el form de borrar-hijo, no es necesario
      const personaIdInp = document.querySelector('#delChildForm [name="personaId"]');
      personaIdInp.parentElement.style.display = (v==='1-N:uni-b') ? 'none' : '';
      localStorage.setItem('variant', v);
    }

    // ===== Listado =====
    async function loadList(){
      const v = variant.value;
      const personasUrl = BASES[v].personas;
      document.getElementById('loadMsg').textContent = 'Cargando...';
      listDiv.textContent = '';
      try{
        const personas = await safeFetch(personasUrl);
        if(v === '1-N:uni-b'){
          // Para cada persona, pedimos sus direcciones por query separado
          const personasConDirs = await Promise.all(personas.map(async p=>{
            const dirs = await safeFetch(`${BASES[v].direcciones}?personaId=${encodeURIComponent(p.id)}`);
            return { ...p, __dirs: dirs };
          }));
          renderListUniB(personasConDirs);
        }else if(v === '1-N:bi' || v === '1-N:uni-a'){
          renderList1N_WithEmbeddedDirs(personas); // BI y UNI-A llevan direcciones embebidas
        }else{
          renderListSimple(personas); // 1–1 casos
        }
        document.getElementById('loadMsg').textContent = '';
      }catch(e){
        listDiv.innerHTML = `<div class="danger">Error: ${esc(e.message)}</div>`;
        document.getElementById('loadMsg').textContent = '';
      }
    }

    function renderListSimple(items){
      if(!Array.isArray(items)||items.length===0){ listDiv.innerHTML='<div class="muted">Sin datos.</div>'; return; }
      listDiv.innerHTML = items.map(p=>{
        return `<div class="card">
          <div><strong>Persona #${esc(p.id)}</strong> — ${esc(p.nombre||'-')}</div>
          <pre>${esc(JSON.stringify(p,null,2))}</pre>
        </div>`;
      }).join('');
    }

    function renderList1N_WithEmbeddedDirs(items){
      if(!Array.isArray(items)||items.length===0){ listDiv.innerHTML='<div class="muted">Sin datos.</div>'; return; }
      listDiv.innerHTML = items.map(p=>{
        const hijos = (p.direcciones||[]);
        const hijosHtml = hijos.length? hijos.map(d=>`<li>#${esc(d.id)} — ${esc(d.calle)}, ${esc(d.ciudad)} ${esc(d.cp)} (${esc(d.provincia)}) ${d.etiqueta? '— '+esc(d.etiqueta):''}</li>`).join('')
          : '<li class="muted">Sin direcciones</li>';
        return `<div class="card">
          <div><strong>Persona #${esc(p.id)}</strong> — ${esc(p.nombre||'-')}</div>
          <ul>${hijosHtml}</ul>
          <pre>${esc(JSON.stringify(p,null,2))}</pre>
        </div>`;
      }).join('');
    }

    function renderListUniB(items){
      if(!Array.isArray(items)||items.length===0){ listDiv.innerHTML='<div class="muted">Sin datos.</div>'; return; }
      listDiv.innerHTML = items.map(p=>{
        const hijos = (p.__dirs||[]);
        const hijosHtml = hijos.length? hijos.map(d=>`<li>#${esc(d.id)} — ${esc(d.calle)}, ${esc(d.ciudad)} ${esc(d.cp)} (${esc(d.provincia)}) ${d.etiqueta? '— '+esc(d.etiqueta):''}</li>`).join('')
          : '<li class="muted">Sin direcciones</li>';
        return `<div class="card">
          <div><strong>Persona #${esc(p.id)}</strong> — ${esc(p.nombre||'-')}</div>
          <ul>${hijosHtml}</ul>
          <pre>${esc(JSON.stringify({id:p.id, nombre:p.nombre, direcciones:p.__dirs},null,2))}</pre>
        </div>`;
      }).join('');
    }

    // ===== Personas – CRUD =====
    document.getElementById('createForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const v = variant.value;
      const base = BASES[v].personas;
      const msg = document.getElementById('createMsg');
      msg.textContent='';
      try{
        const nombre = new FormData(ev.target).get('nombre');
        await safeFetch(base, { method:'POST', body:JSON.stringify({ nombre }) });
        msg.innerHTML = `<span class="ok">Creado</span>`;
        ev.target.reset(); loadList();
      }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
    });

    document.getElementById('updateForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const v = variant.value;
      const base = BASES[v].personas;
      const msg = document.getElementById('updateMsg');
      msg.textContent='';
      try{
        const fd = new FormData(ev.target);
        const id = fd.get('id');
        const nombre = fd.get('nombre');
        await safeFetch(`${base}/${encodeURIComponent(id)}`, { method:'PUT', body:JSON.stringify({ nombre }) });
        msg.innerHTML = `<span class="ok">Actualizado</span>`;
        ev.target.reset(); loadList();
      }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
    });

    document.getElementById('deleteForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const v = variant.value;
      const base = BASES[v].personas;
      const msg = document.getElementById('deleteMsg');
      msg.textContent='';
      try{
        const id = new FormData(ev.target).get('id');
        await safeFetch(`${base}/${encodeURIComponent(id)}`, { method:'DELETE' });
        msg.innerHTML = `<span class="ok">Eliminado</span>`;
        ev.target.reset(); loadList();
      }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
    });

    // ===== Direcciones – Añadir / Eliminar =====
    document.getElementById('addChildForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const v = variant.value;
      const msg = document.getElementById('addChildMsg'); msg.textContent='';
      try{
        const fd = new FormData(ev.target);
        const personaId = fd.get('id');

        // recoger campos de dirección
        const r = document.querySelector('#addChildDynamic');
        const get = (n) => r.querySelector(`[name="addChild.${n}"]`).value.trim();
        const body = {
          calle:get('calle'), ciudad:get('ciudad'), cp:get('cp'), provincia:get('provincia')
        };
        const etiqueta = get('etiqueta'); if(etiqueta) body.etiqueta = etiqueta;

        if(v === '1-N:bi' || v === '1-N:uni-a'){
          // POST anidado: /personas/{id}/direcciones
          const url = `${BASES[v].personas}/${encodeURIComponent(personaId)}/direcciones`;
          await safeFetch(url,{ method:'POST', body:JSON.stringify(body) });
        }else if(v === '1-N:uni-b'){
          // POST plano: /r1nuni-b/direcciones  con { persona:{id}, ... }
          const url = `${BASES[v].direcciones}`;
          await safeFetch(url,{ method:'POST', body:JSON.stringify({ persona:{ id:Number(personaId) }, ...body }) });
        }else{
          throw new Error('Añadir dirección solo aplica a 1–N');
        }

        msg.innerHTML = `<span class="ok">Añadida</span>`;
        ev.target.reset(); loadList();
      }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
    });

    document.getElementById('delChildForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const v = variant.value;
      const msg = document.getElementById('delChildMsg'); msg.textContent='';
      try{
        const fd = new FormData(ev.target);
        const childId = fd.get('childId');

        if(v === '1-N:bi' || v === '1-N:uni-a'){
          const personaId = fd.get('personaId');
          const url = `${BASES[v].personas}/${encodeURIComponent(personaId)}/direcciones/${encodeURIComponent(childId)}`;
          await safeFetch(url,{ method:'DELETE' });
        }else if(v === '1-N:uni-b'){
          const url = `${BASES[v].direcciones}/${encodeURIComponent(childId)}`;
          await safeFetch(url,{ method:'DELETE' });
        }else{
          throw new Error('Eliminar dirección solo aplica a 1–N');
        }

        msg.innerHTML = `<span class="ok">Eliminada</span>`;
        ev.target.reset(); loadList();
      }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
    });

    // ===== eventos =====
    rel.addEventListener('change', setVariants);
    variant.addEventListener('change', ()=>{ rebuildDynamicForms(); loadList(); });
    document.getElementById('reloadBtn').addEventListener('click', loadList);

    // init
    (function init(){
      const savedRel = localStorage.getItem('rel'); if(savedRel) rel.value=savedRel;
      setVariants();
      rel.addEventListener('change', ()=>localStorage.setItem('rel', rel.value));
    })();
</script>
</body>
</html>
