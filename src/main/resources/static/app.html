<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Relaciones JPA – Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { --gap: 10px; --muted:#6b7280; --ok:#16a34a; --err:#dc2626; }
        body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; margin:20px; }
        h1 { margin:0 0 8px; }
        .row { display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center; }
        label { font-size:14px; }
        input, select, button, textarea { padding:8px; font-size:14px; }
        input[type="number"]{ width:110px; }
        .card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin:10px 0; background:#fff; }
        .muted { color:var(--muted); }
        .ok { color:#fff; background:var(--ok); padding:2px 6px; border-radius:6px; }
        .danger { color:#fff; background:var(--err); padding:8px; border-radius:8px; }
        pre { background:#f8fafc; border:1px solid #e5e7eb; padding:8px; border-radius:8px; overflow:auto; }
        .grid { display:grid; gap:var(--gap); grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); }
        .section-title { margin-top:20px; }
        .small { font-size:12px; }
    </style>
</head>
<body>
<h1>Relaciones JPA – Tester</h1>

<div class="row card">
    <div>
        <label>Relación:</label>
        <select id="rel">
            <option value="1-1">1–1</option>
            <option value="1-N">1–N</option>
            <option value="N-M" selected>N–M</option>
        </select>
    </div>
    <div>
        <label>Variante:</label>
        <select id="variant"></select>
    </div>
    <div class="small muted">Los endpoints se fijan automáticamente según la variante.</div>
</div>

<div class="grid" id="formsGrid"></div>

<div class="card">
    <div class="row">
        <button id="reloadBtn">Recargar listado</button>
        <span id="loadMsg" class="small muted"></span>
    </div>
    <div id="list"></div>
</div>

<script>
    // ===== util =====
    const esc = s => (s==null?'':String(s))
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");
    async function safeFetch(url, opts={}){
      const o = { headers:{'Content-Type':'application/json'}, ...opts };
      const res = await fetch(url, o);
      if(!res.ok){
        let detail = '';
        try{ const j = await res.json(); detail = j.detail || j.message || JSON.stringify(j); }catch{}
        throw new Error(`${res.status} ${res.statusText}${detail? ' — '+detail : ''}`);
      }
      if (res.status === 204) return null;
      return res.json();
    }

    // ===== state y variantes =====
    const rel = document.getElementById('rel');
    const variant = document.getElementById('variant');
    const listDiv = document.getElementById('list');
    const formsGrid = document.getElementById('formsGrid');

    const BASES = {
      '1-1:bi':      { personas: 'http://localhost:8081/r11bi/personas' },
      '1-1:uni':     { personas: 'http://localhost:8081/r11uni/personas' },
      '1-N:bi':      { personas: 'http://localhost:8081/r1nbi/personas' },
      '1-N:uni-a':   { personas: 'http://localhost:8081/r1nuni-a/personas' },
      '1-N:uni-b':   { personas: 'http://localhost:8081/r1nuni-b/personas',
                       direcciones:'http://localhost:8081/r1nuni-b/direcciones' },
      'N-M:bi':      { personas: 'http://localhost:8081/rnmbi/personas',
                       proyectos:'http://localhost:8081/rnmbi/proyectos' },
      'N-M:uni':     { personas: 'http://localhost:8081/rnmuni/personas',
                       proyectos:'http://localhost:8081/rnmuni/proyectos' }
    };

    function addOpt(sel, label, val){ const o=document.createElement('option'); o.value=val; o.textContent=label; sel.appendChild(o); }

    function setVariants(){
      variant.innerHTML='';
      if(rel.value==='1-1'){
        addOpt(variant,'BI (/r11bi/personas)','1-1:bi');
        addOpt(variant,'UNI (/r11uni/personas)','1-1:uni');
      }else if(rel.value==='1-N'){
        addOpt(variant,'BI (/r1nbi/personas)','1-N:bi');
        addOpt(variant,'UNI-A (per → dir)','1-N:uni-a');
        addOpt(variant,'UNI-B (dir → per)','1-N:uni-b');
      }else{
        addOpt(variant,'BI (N–M: personas y proyectos)','N-M:bi');
        addOpt(variant,'UNI (N–M unidireccional)','N-M:uni');
      }
      const saved = localStorage.getItem('variant');
      if(saved && [...variant.options].some(o=>o.value===saved)) variant.value=saved;
      rebuildForms();
      loadList();
    }

    // ===== UI forms por variante =====
    function formPersonasCRUD(){
      return `
      <div class="card">
        <h3 class="section-title">Personas — CRUD</h3>
        <form id="createPersonaForm" class="row">
          <input name="nombre" placeholder="nombre (crear)" required />
          <button>Crear</button><span id="createPersonaMsg"></span>
        </form>
        <form id="updatePersonaForm" class="row">
          <input name="id" type="number" placeholder="id (update)" required />
          <input name="nombre" placeholder="nuevo nombre" />
          <button>Actualizar</button><span id="updatePersonaMsg"></span>
        </form>
        <form id="deletePersonaForm" class="row">
          <input name="id" type="number" placeholder="id (delete)" required />
          <button>Eliminar</button><span id="deletePersonaMsg"></span>
        </form>
      </div>`;
    }

    function formDirecciones(){
      return `
      <div class="card">
        <h3 class="section-title">Direcciones — Añadir / Eliminar</h3>
        <form id="addChildForm">
          <div class="row"><input name="id" type="number" placeholder="ID persona (padre)" required /></div>
          <div id="addChildDynamic" class="row">
            <input name="addChild.calle" placeholder="calle" required />
            <input name="addChild.ciudad" placeholder="ciudad" required />
            <input name="addChild.cp" placeholder="cp" required />
            <input name="addChild.provincia" placeholder="provincia" required />
            <input name="addChild.etiqueta" placeholder="etiqueta (opcional)" />
          </div>
          <div class="row"><button>Añadir dirección</button><span id="addChildMsg"></span></div>
        </form>
        <hr/>
        <form id="delChildForm" class="row">
          <span>Eliminar dirección:</span>
          <input name="personaId" type="number" placeholder="ID persona" />
          <input name="childId" type="number" placeholder="ID dirección" required />
          <button>Eliminar</button><span id="delChildMsg"></span>
        </form>
        <div class="small muted">En UNI-B no hace falta el ID de persona para borrar; se oculta automáticamente.</div>
      </div>`;
    }

    function formProyectosCRUD(){
      return `
      <div class="card">
        <h3 class="section-title">Proyectos — CRUD</h3>
        <form id="createProyectoForm" class="row">
          <input name="nombre" placeholder="nombre (crear)" required />
          <button>Crear</button><span id="createProyectoMsg"></span>
        </form>
        <form id="updateProyectoForm" class="row">
          <input name="id" type="number" placeholder="id (update)" required />
          <input name="nombre" placeholder="nuevo nombre" />
          <button>Actualizar</button><span id="updateProyectoMsg"></span>
        </form>
        <form id="deleteProyectoForm" class="row">
          <input name="id" type="number" placeholder="id (delete)" required />
          <button>Eliminar</button><span id="deleteProyectoMsg"></span>
        </form>
      </div>`;
    }

    function formNmVinculos(){
      return `
      <div class="card">
        <h3 class="section-title">Vínculos Persona ↔ Proyecto</h3>
        <form id="vincularForm" class="row">
          <input name="personaId" type="number" placeholder="ID persona" required />
          <input name="proyectoId" type="number" placeholder="ID proyecto" required />
          <button>Vincular</button><span id="vincularMsg"></span>
        </form>
        <form id="desvincularForm" class="row">
          <input name="personaId" type="number" placeholder="ID persona" required />
          <input name="proyectoId" type="number" placeholder="ID proyecto" required />
          <button>Desvincular</button><span id="desvincularMsg"></span>
        </form>
        <div class="small muted">Si ya existe el vínculo, devolverá 409.</div>
      </div>`;
    }

    function rebuildForms(){
      const v = variant.value;
      formsGrid.innerHTML = '';
      if(v==='1-1:bi' || v==='1-1:uni'){
        formsGrid.innerHTML = formPersonasCRUD();
        bindPersonasCrud();
      } else if (v==='1-N:bi' || v==='1-N:uni-a' || v==='1-N:uni-b'){
        formsGrid.innerHTML = formPersonasCRUD() + formDirecciones();
        bindPersonasCrud(); bindDireccionesForms();
        const personaIdInp = document.querySelector('#delChildForm [name="personaId"]');
        if (personaIdInp) personaIdInp.parentElement.style.display = (v==='1-N:uni-b') ? 'none' : '';
      } else if (v==='N-M:bi' || v==='N-M:uni'){
        formsGrid.innerHTML = formPersonasCRUD() + formProyectosCRUD() + formNmVinculos();
        bindPersonasCrud(); bindProyectosCrud(); bindNmVinculos();
      }
      localStorage.setItem('variant', v);
    }

    // ===== Listado =====
    async function loadList(){
      const v = variant.value;
      document.getElementById('loadMsg').textContent = 'Cargando...';
      listDiv.textContent = '';
      try{
        if(v==='N-M:bi' || v==='N-M:uni'){
          const personas = await safeFetch(BASES[v].personas);
          renderListNm(personas);
        } else if(v === '1-N:uni-b'){
          const personas = await safeFetch(BASES[v].personas);
          const personasConDirs = await Promise.all(personas.map(async p=>{
            const dirs = await safeFetch(`${BASES[v].direcciones}?personaId=${encodeURIComponent(p.id)}`);
            return { ...p, __dirs: dirs };
          }));
          renderListUniB(personasConDirs);
        } else if(v === '1-N:bi' || v === '1-N:uni-a'){
          const personas = await safeFetch(BASES[v].personas);
          renderList1N_WithEmbeddedDirs(personas);
        } else {
          const personas = await safeFetch(BASES[v].personas);
          renderListSimple(personas);
        }
        document.getElementById('loadMsg').textContent = '';
      }catch(e){
        listDiv.innerHTML = `<div class="danger">Error: ${esc(e.message)}</div>`;
        document.getElementById('loadMsg').textContent = '';
      }
    }

    function renderListSimple(items){
      if(!Array.isArray(items)||items.length===0){ listDiv.innerHTML='<div class="muted">Sin datos.</div>'; return; }
      listDiv.innerHTML = items.map(p=>{
        return `<div class="card">
          <div><strong>Persona #${esc(p.id)}</strong> — ${esc(p.nombre||'-')}</div>
          <pre>${esc(JSON.stringify(p,null,2))}</pre>
        </div>`;
      }).join('');
    }

    function renderList1N_WithEmbeddedDirs(items){
      if(!Array.isArray(items)||items.length===0){ listDiv.innerHTML='<div class="muted">Sin datos.</div>'; return; }
      listDiv.innerHTML = items.map(p=>{
        const hijos = (p.direcciones||[]);
        const hijosHtml = hijos.length? hijos.map(d=>`<li>#${esc(d.id)} — ${esc(d.calle)}, ${esc(d.ciudad)} ${esc(d.cp)} (${esc(d.provincia)}) ${d.etiqueta? '— '+esc(d.etiqueta):''}</li>`).join('')
          : '<li class="muted">Sin direcciones</li>';
        return `<div class="card">
          <div><strong>Persona #${esc(p.id)}</strong> — ${esc(p.nombre||'-')}</div>
          <ul>${hijosHtml}</ul>
          <pre>${esc(JSON.stringify(p,null,2))}</pre>
        </div>`;
      }).join('');
    }

    function renderListUniB(items){
      if(!Array.isArray(items)||items.length===0){ listDiv.innerHTML='<div class="muted">Sin datos.</div>'; return; }
      listDiv.innerHTML = items.map(p=>{
        const hijos = (p.__dirs||[]);
        const hijosHtml = hijos.length? hijos.map(d=>`<li>#${esc(d.id)} — ${esc(d.calle)}, ${esc(d.ciudad)} ${esc(d.cp)} (${esc(d.provincia)}) ${d.etiqueta? '— '+esc(d.etiqueta):''}</li>`).join('')
          : '<li class="muted">Sin direcciones</li>';
        return `<div class="card">
          <div><strong>Persona #${esc(p.id)}</strong> — ${esc(p.nombre||'-')}</div>
          <ul>${hijosHtml}</ul>
          <pre>${esc(JSON.stringify({id:p.id, nombre:p.nombre, direcciones:p.__dirs},null,2))}</pre>
        </div>`;
      }).join('');
    }

    function renderListNm(personas){
      if(!Array.isArray(personas)||personas.length===0){ listDiv.innerHTML='<div class="muted">Sin datos.</div>'; return; }
      listDiv.innerHTML = personas.map(p=>{
        const pros = Array.isArray(p.proyectos) ? p.proyectos : [];
        const prosHtml = pros.length
          ? pros.map(pr => `<li>#${esc(pr.id)} — ${esc(pr.nombre||'-')}</li>`).join('')
          : '<li class="muted">Sin proyectos</li>';
        return `<div class="card">
          <div><strong>Persona #${esc(p.id)}</strong> — ${esc(p.nombre||'-')}</div>
          <div class="small muted">Proyectos vinculados:</div>
          <ul>${prosHtml}</ul>
          <pre>${esc(JSON.stringify(p,null,2))}</pre>
        </div>`;
      }).join('');
    }

    // ===== Binds: Personas CRUD =====
    function bindPersonasCrud(){
      const v = variant.value, base = BASES[v].personas;

      document.getElementById('createPersonaForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('createPersonaMsg'); msg.textContent='';
        try{
          const nombre = new FormData(ev.target).get('nombre');
          await safeFetch(base, { method:'POST', body:JSON.stringify({ nombre }) });
          msg.innerHTML = `<span class="ok">Creado</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });

      document.getElementById('updatePersonaForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('updatePersonaMsg'); msg.textContent='';
        try{
          const fd = new FormData(ev.target);
          const id = fd.get('id'); const nombre = fd.get('nombre');
          await safeFetch(`${base}/${encodeURIComponent(id)}`, { method:'PUT', body:JSON.stringify({ nombre }) });
          msg.innerHTML = `<span class="ok">Actualizado</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });

      document.getElementById('deletePersonaForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('deletePersonaMsg'); msg.textContent='';
        try{
          const id = new FormData(ev.target).get('id');
          await safeFetch(`${base}/${encodeURIComponent(id)}`, { method:'DELETE' });
          msg.innerHTML = `<span class="ok">Eliminado</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });
    }

    // ===== Binds: Direcciones (1-N) =====
    function bindDireccionesForms(){
      const v = variant.value;

      document.getElementById('addChildForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('addChildMsg'); msg.textContent='';
        try{
          const fd = new FormData(ev.target);
          const personaId = fd.get('id');

          const get = (n) => fd.get(`addChild.${n}`)?.toString().trim();
          const body = { calle:get('calle'), ciudad:get('ciudad'), cp:get('cp'), provincia:get('provincia') };
          const etiqueta = get('etiqueta'); if(etiqueta) body.etiqueta = etiqueta;

          if(v === '1-N:bi' || v === '1-N:uni-a'){
            const url = `${BASES[v].personas}/${encodeURIComponent(personaId)}/direcciones`;
            await safeFetch(url,{ method:'POST', body:JSON.stringify(body) });
          }else if(v === '1-N:uni-b'){
            const url = `${BASES[v].direcciones}`;
            await safeFetch(url,{ method:'POST', body:JSON.stringify({ persona:{ id:Number(personaId) }, ...body }) });
          }

          msg.innerHTML = `<span class="ok">Añadida</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });

      document.getElementById('delChildForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('delChildMsg'); msg.textContent='';
        try{
          const fd = new FormData(ev.target);
          const childId = fd.get('childId');

          if(v === '1-N:bi' || v === '1-N:uni-a'){
            const personaId = fd.get('personaId');
            const url = `${BASES[v].personas}/${encodeURIComponent(personaId)}/direcciones/${encodeURIComponent(childId)}`;
            await safeFetch(url,{ method:'DELETE' });
          }else if(v === '1-N:uni-b'){
            const url = `${BASES[v].direcciones}/${encodeURIComponent(childId)}`;
            await safeFetch(url,{ method:'DELETE' });
          }

          msg.innerHTML = `<span class="ok">Eliminada</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });
    }

    // ===== Binds: Proyectos CRUD (N–M) =====
    function bindProyectosCrud(){
      const v = variant.value, base = BASES[v].proyectos;

      document.getElementById('createProyectoForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('createProyectoMsg'); msg.textContent='';
        try{
          const nombre = new FormData(ev.target).get('nombre');
          await safeFetch(base, { method:'POST', body:JSON.stringify({ nombre }) });
          msg.innerHTML = `<span class="ok">Creado</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });

      document.getElementById('updateProyectoForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('updateProyectoMsg'); msg.textContent='';
        try{
          const fd = new FormData(ev.target);
          const id = fd.get('id'); const nombre = fd.get('nombre');
          await safeFetch(`${base}/${encodeURIComponent(id)}`, { method:'PUT', body:JSON.stringify({ nombre }) });
          msg.innerHTML = `<span class="ok">Actualizado</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });

      document.getElementById('deleteProyectoForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('deleteProyectoMsg'); msg.textContent='';
        try{
          const id = new FormData(ev.target).get('id');
          await safeFetch(`${base}/${encodeURIComponent(id)}`, { method:'DELETE' });
          msg.innerHTML = `<span class="ok">Eliminado</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });
    }

    // ===== Binds: Vincular / Desvincular (N–M) =====
    function bindNmVinculos(){
      const v = variant.value, base = BASES[v];

      document.getElementById('vincularForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('vincularMsg'); msg.textContent='';
        try{
          const fd = new FormData(ev.target);
          const personaId = fd.get('personaId');
          const proyectoId = fd.get('proyectoId');
          const url = `${base.personas}/${encodeURIComponent(personaId)}/proyectos/${encodeURIComponent(proyectoId)}`;
          await safeFetch(url, { method:'POST' });
          msg.innerHTML = `<span class="ok">Vinculado</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });

      document.getElementById('desvincularForm')?.addEventListener('submit', async ev=>{
        ev.preventDefault();
        const msg = document.getElementById('desvincularMsg'); msg.textContent='';
        try{
          const fd = new FormData(ev.target);
          const personaId = fd.get('personaId');
          const proyectoId = fd.get('proyectoId');
          const url = `${base.personas}/${encodeURIComponent(personaId)}/proyectos/${encodeURIComponent(proyectoId)}`;
          await safeFetch(url, { method:'DELETE' });
          msg.innerHTML = `<span class="ok">Desvinculado</span>`;
          ev.target.reset(); loadList();
        }catch(e){ msg.innerHTML = `<span class="danger">${esc(e.message)}</span>`; }
      });
    }

    // ===== eventos =====
    rel.addEventListener('change', setVariants);
    variant.addEventListener('change', ()=>{ rebuildForms(); loadList(); });
    document.getElementById('reloadBtn').addEventListener('click', loadList);

    // init
    (function init(){
      const savedRel = localStorage.getItem('rel'); if(savedRel) rel.value=savedRel;
      setVariants();
      rel.addEventListener('change', ()=>localStorage.setItem('rel', rel.value));
    })();
</script>
</body>
</html>
